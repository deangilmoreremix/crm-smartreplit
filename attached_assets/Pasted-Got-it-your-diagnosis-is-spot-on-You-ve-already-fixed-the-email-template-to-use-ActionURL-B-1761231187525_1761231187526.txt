Got it—your diagnosis is spot-on. You’ve already fixed the email template to use {{ .ActionURL }}. Below is a tight end-to-end fix for the React + Vite + React Router stack (SmartCRM’s primary setup), plus a Next.js variant in case you need it elsewhere.

1) Supabase Dashboard settings (single pass)

Authentication → URL Configuration

Site URL: https://your-domain.com (your main app origin)

Redirect URLs (Allowed URLs) – add your reset route(s):

https://your-domain.com/auth/reset-password

http://localhost:5173/auth/reset-password (Vite dev)

If you also test at 3000: http://localhost:3000/auth/reset-password

Tip: If you have multiple branded domains (e.g., preview.*.smartcrm.vip), add each preview origin + the reset path.

2) React + Vite + React Router implementation
/src/lib/supabaseClient.ts
import { createClient } from '@supabase/supabase-js';

export const supabase = createClient(
  import.meta.env.VITE_SUPABASE_URL!,
  import.meta.env.VITE_SUPABASE_ANON_KEY!
);

Public route guard: allow /auth/reset-password

If you have a global guard (common pitfall), ensure this route is public.

// /src/router.tsx (example)
import { createBrowserRouter, Navigate } from 'react-router-dom';
import App from './App';
import ResetPassword from './routes/auth/ResetPassword';

// Example protected wrapper
function Protected({ children }: { children: React.ReactNode }) {
  // Replace with your real session logic (context/store)
  const isAuthed = false; // <- example
  const isResetRoute = window.location.pathname.startsWith('/auth/reset-password');

  // Always allow reset route to render even if unauthenticated
  if (isResetRoute) return <>{children}</>;

  return isAuthed ? <>{children}</> : <Navigate to="/login" replace />;
}

export const router = createBrowserRouter([
  {
    path: '/',
    element: (
      <Protected>
        <App />
      </Protected>
    ),
  },
  {
    path: '/auth/reset-password',
    element: <ResetPassword />,
  },
  // ...other routes
]);

/src/routes/auth/ResetPassword.tsx

Robust handler for both OAuth code flow and access tokens (query or hash), no early redirect until password update completes.

import { useEffect, useMemo, useState } from 'react';
import { supabase } from '../../lib/supabaseClient';

export default function ResetPassword() {
  const [stage, setStage] = useState<'init' | 'ready' | 'submitting' | 'done' | 'error'>('init');
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [password, setPassword] = useState('');
  const [confirm, setConfirm] = useState('');

  // Helper to parse both query & hash
  const urlData = useMemo(() => {
    const url = new URL(window.location.href);
    const code = url.searchParams.get('code');
    const qpAccessToken = url.searchParams.get('access_token');

    const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, ''));
    const hashAccessToken = hashParams.get('access_token');

    return {
      code,
      accessToken: qpAccessToken || hashAccessToken || null,
    };
  }, []);

  useEffect(() => {
    let active = true;

    (async () => {
      try {
        // 1) If code present (PKCE/OAuth password recovery), exchange for session
        if (urlData.code) {
          const { error } = await supabase.auth.exchangeCodeForSession(urlData.code);
          if (error) throw error;
        }
        // If access_token is present in URL, supabase-js will usually pick it up automatically
        // when the client initializes. We just proceed to the reset UI.
        if (active) setStage('ready');
      } catch (err: any) {
        if (!active) return;
        setErrorMsg(err?.message || 'Unable to verify reset link. It may be expired or already used.');
        setStage('error');
      }
    })();

    return () => {
      active = false;
    };
  }, [urlData.code]);

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setErrorMsg(null);

    if (!password || password.length < 8) {
      setErrorMsg('Password must be at least 8 characters.');
      return;
    }
    if (password !== confirm) {
      setErrorMsg('Passwords do not match.');
      return;
    }

    setStage('submitting');
    const { error } = await supabase.auth.updateUser({ password });
    if (error) {
      setErrorMsg(error.message);
      setStage('ready');
      return;
    }

    // ✅ success: now safe to redirect
    setStage('done');
    // example: go to login or app
    window.location.replace('/login'); // or '/app'
  };

  if (stage === 'init') {
    return <div style={{ padding: 24 }}>Validating reset link…</div>;
  }

  if (stage === 'error') {
    return (
      <div style={{ padding: 24 }}>
        <h2>Reset Link Issue</h2>
        <p style={{ color: 'crimson' }}>{errorMsg}</p>
        <p>Please request a new password reset and try again.</p>
      </div>
    );
  }

  if (stage === 'done') {
    return (
      <div style={{ padding: 24 }}>
        <h2>Password Updated</h2>
        <p>Redirecting…</p>
      </div>
    );
  }

  // 'ready' or 'submitting'
  return (
    <div style={{ maxWidth: 420, margin: '40px auto', padding: 24 }}>
      <h2>Set a New Password</h2>
      <p>Enter your new password for SmartCRM.</p>

      {errorMsg && <p style={{ color: 'crimson' }}>{errorMsg}</p>}

      <form onSubmit={onSubmit}>
        <div style={{ margin: '12px 0' }}>
          <label>New Password</label>
          <input
            type="password"
            value={password}
            onChange={e => setPassword(e.target.value)}
            placeholder="••••••••"
            style={{ display: 'block', width: '100%', padding: 10, marginTop: 6 }}
            autoComplete="new-password"
          />
        </div>
        <div style={{ margin: '12px 0' }}>
          <label>Confirm Password</label>
          <input
            type="password"
            value={confirm}
            onChange={e => setConfirm(e.target.value)}
            placeholder="••••••••"
            style={{ display: 'block', width: '100%', padding: 10, marginTop: 6 }}
            autoComplete="new-password"
          />
        </div>

        <button
          type="submit"
          disabled={stage === 'submitting'}
          style={{ padding: '10px 16px' }}
        >
          {stage === 'submitting' ? 'Updating…' : 'Update Password'}
        </button>
      </form>
    </div>
  );
}